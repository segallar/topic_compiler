<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!--link rel="icon" href="../../favicon.ico"-->

    <title>Topic compiler</title>
   
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css" />

    <!-- Custom styles for this template -->
    <link href="tc.css" rel="stylesheet" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
      
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand menu-item" href="#" onclick="menuClick('');" id="menu-item-">Topic compiler</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav" id="menu">
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

      <div class="main-text" id="main-text-">
            <h1>Topic compiler</h1>
            <p style="text-align:left">This is topic_compiler v0.1</p>
            <p style="text-align:left" id="main-text-hello"></p>
            <div class="col-md-6 col-md-offset-3" align="left" id="login_form">
              <div class="form-group">
                <label for="exampleInputEmail1">Email address</label>
                <input type="email" class="form-control" id="exampleInputEmail1" placeholder="Email">
              </div>
              <div class="form-group">
                <label for="exampleInputPassword1">Password</label>
                <input type="password" class="form-control" id="exampleInputPassword1" placeholder="Password">
              </div>
              <button type="submit" class="btn btn-primary" onClick="submit_auth()">Submit</button>
            </div>
            
            <div class="row col-md-6 col-md-offset-3">
                <br/>
                <p style="text-align:left" id="test"> Testing connection to server ... </p>
            </div>
        </div>
  
      <div class="main-text" id="main-text-analytic">
           <h2>Analytic</h2>    
      </div>    
                
      <div class="main-text" id="main-text-texts"> 
          <div style="text-align:left"><br/>
          <a class="btn btn-default" href="javascript:text_list_load()">Refresh</a>
          </div>
          <table class="table table-striped table-condensed" style="text-align:left;">
          <thead><tr><th>Name</th><th>Author</th><th>Language</th><th>Time</th><th>User</th></tr></thead> 
          <tbody id="text-list-tbl"></tbody>
          </table>
      </div>
      
      <div class="main-text" id="main-text-texts_show">
          <a name="text-show-top"></a>
          <div id="text-show">
             <div id="text-show-status"></div>
             <div id="text-show-div" style="text-align:left">Loading...</div> 
          </div>
      </div>
        
      <div class="main-text" id="main-text-texts_upload" style="text-align:left">
          <form><br/>
          <div class="form-group">
              <label for="text-name">Name of text</label>
              <input id="text-name" type="text" class="form-control" placeholder="Text name">
          </div>
          <div class="form-group">
              <label for="text-author">Author</label>
              <input id="text-author" type="text" class="form-control" placeholder="Author">
          </div>
          <div class="form-group">
              <label for="text-input">Put your text here...</label>
              <textarea class="form-control" id="text-input"></textarea>
          </div>
          <div class="form-group" align=left>
              <a class="btn btn-primary" href="javascript:text_upload()">Upload</a>
              <a class="btn btn-default" href="javascript:text_clear()">Clear form</a>
          </div>
          </form>      
          <div id="text-status" class="alert hidden" role="alert"></div>
      </div>
      
      <div class="main-text" id="main-text-dics">
           <h2>Dictionary</h2>
           <div>
           <ul class="nav nav-pills">
              <li role="presentation" id="dic-pill-list" class="dic-pill active"><a href="javascript:dic_click('list')">List</a></li>
              <li role="presentation" id="dic-pill-show" class="dic-pill" style="display:none">
                  <a href="javascript:dic_click('show')">Word</a></li>
              <li role="presentation" id="dic-pill-upload" class="dic-pill"><a href="javascript:dic_click('upload')">Upload</a></li>
              <li role="presentation" id="dic-pill-dict" class="dic-pill"><a href="javascript:dic_click('dict')">Dictionaries</a></li> 
              <li role="presentation" id="dic-pill-dicadd" class="dic-pill" style="display:none">
                  <a href="javascript:dic_click('dicadd')">Options</a></li> 
           </ul>
           </div>
          
          <div id="dic-page-list" class="dic-page"> Words list </div>
          
          <div id="dic-page-dict" class="dic-page" style="text-align:left;display:none">
              <a class="btn btn-primary" href="javascript:dic_add_dic()">Add new one</a>
              <table class="table table-striped table-condensed" style="text-align:left;">
              <thead><tr><th>Name</th><th>Status</th><th>Language</th><th>URL</th><th>Time</th><th>User</th></tr></thead> 
              <tbody id="dic-dict-tbl"></tbody></table>
          </div>
          
          <div id="dic-page-dicadd" class="dic-page" style="text-align:left;display:none">
              <form>
                <div class="form-group">
                    <label for="dic-name">Dictionary name</label>
                    <input id="dic-name" type="text" class="form-control" placeholder="Dictionary name" />
                </div>
                <div class="form-group">
                    <label for="dic-url">URL</label>
                    <input id="dic-url" type="text" class="form-control" placeholder="URL" />
                </div>
                <div class="form-group">
                    <label for="dic-file">File</label>
                    <input id="dic-file" type="file" enctype="multipart/form-data" class="form-control" placeholder="" />
                    <a class="btn btn-default" id="dic-file-btn" href="javascript:dic_upload(-1)">Upload</a>
                </div>      
                <div class="form-group">
                    <label for="dic-comment">Comments</label>
                    <textarea class="form-control" id="dic-comment"></textarea>
                </div>
                <div class="form-group" align=left>
                  <a class="btn btn-primary" href="javascript:dic_process('upd',-1)" id="dic-page-dicadd-sub">Add new ...</a>
                  <a class="btn btn-default" href="javascript:dic_clear()" id="dic-page-dicadd-clr">Clear form</a>
                  <a class="btn btn-danger" id="dic-page-dicadd-del" style="display:none">Delete</a>  
                </div> 
              </form>
              <div id="dic-status" class="alert hidden" role="alert"></div>
          </div>
          
      </div>    
        
      <div class="main-text" id="main-text-user">
          <br/><a class="btn btn-primary" href="javascript:logout()" role="button">Logout</a>
          <table class="table table-striped table-condensed">
              <thead><tr><th>Parameter</th><th>Value</th></tr></thead>
              <tbody id="user-tbl"></tbody>
          </table>
      </div>
     
      <!-- for menu test -->
        
      <div class="main-text" id="main-text-test"> test </div>
 
      <div class="main-text" id="main-text-tst1"> test1 </div>
        
      <div class="main-text" id="main-text-tst2"> test2 </div>
        
    <div class="point" id="point"></div>
    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="lib/jquery/jquery-2.1.1.min.js"></script>
    <script src="lib/bootstrap/js/bootstrap.min.js"></script>

<script>
 
"use strict";
    
//
// common part
//
    
if (!Array.prototype.remove) {
  Array.prototype.remove = function(val) {
    var i = this.indexOf(val);
         return i>-1 ? this.splice(i, 1) : [];
  };
}
    
var isFunc = function(func) { 
    return typeof window[func] === "function"; 
}        

var auth = false;

//
// Texts
//
    
var marked = Array();
    
function texts_click(firstrun) {
    if(firstrun) {
        text_list_load();
    }
}
 
function text_list_load() {
    $("#text-list-tbl").html("");
    $.getJSON("/server.php?cmd=texts_lst", function (data) {
        $.each( data , function (key, val) {
            var id = val['id'];
            var s = "<tr>";
            s += "<td>";
            s += "<a href=\"javascript:text_list_menu("+id+")\">";
            s += "<span class=\"glyphicon glyphicon-option-vertical\"></span></a>";
            s += "<a href=\"javascript:text_show("+id+", "+val['processed']+")\">"+val["name"]+"</a>";
            if(val['processed']==0) {
                s += "&nbsp;<a href=\"javascript:text_analyse("+id+")\"><span class=\"label label-info\">RAW</span></a>";
            }
            s += "<div id=\"text-list-menu-"+id+"\" style=\"display:none\">";
            s += "<a class=\"btn btn-danger btn-xs disabled\">Delete</a></div>";
            s += "</td>";
            s += "<td>"+val["author"]+"</td>";
            s += "<td>"+val["lang"]+"</td>";
            s += "<td>"+val["ts"]+"</td>";
            s += "<td>"+val["user"]+"</td></tr>";
            $(s).appendTo("#text-list-tbl");
        });
    }); 
}
    
function text_list_menu(id) {
    $("#text-list-menu-"+id).show();
}
    
function text_show_marks(id) {
    $("#text-show-marks"+id).html();
    var s = "";
    s += "<li><a href=\"#top\"><b>Top</b></a></li>";
    s += "<li role=\"separator\" class=\"divider\"></li>";    
    $.each( marked , function (key, val) {
        s += "<li><a href=\"#text-show-jmp-"+val+"\"><b>"+$("#text-show-seq-"+val).text();
        s += "</b> "+$("#text-show-comment-"+val).val()+"</a></li>";
    });
    $("#text-show-marks-"+id).html(s);
}    

function text_show_menu(id) {
    if(!$("#text-show-menu-"+id).hasClass("menu")) {
        var s = "<form class=\"form-inline\">";
        s += "<div class=\"form-group btn-group\">";
        s += "<a class=\"btn btn-default dropdown-toggle\" data-toggle=\"dropdown\" onClick=\"text_show_marks("+id+")\">Jump";
        s += " <span class=\"caret\"></span></a>";
        s += "<ul class=\"dropdown-menu\" id=\"text-show-marks-"+id+"\">";
        s += "</ul></div>&nbsp;";
        s += "<div class=\"form-group\"><label for=\"text-show-comment-"+id+"\">Comment:</label>&nbsp;";
        s += "<input type=\"text\" id=\"text-show-comment-"+id+"\" class=\"form-control\"></div>&nbsp;";
        s += "<div class=\"form-group\">"
        s += "<a class=\"btn btn-primary\" href=\"javascript:text_show_mark("+id+")\">Mark</a></div>";
        s += "</form>";
        $(s).appendTo("#text-show-menu-"+id);
        $("#text-show-menu-"+id).addClass("menu");
    }
}
    
function text_show_mark(id) {
    // visual
    if(  $("#text-show-menu-"+id).hasClass("marked") ) {
        $("#text-show-menu-"+id).css("background-color","white").removeClass("marked");
        marked.remove(id);
    } else {
        $("#text-show-menu-"+id).css("background-color","yellow").addClass("marked");
        marked.push(id);
    }
}
    
function text_analyse(id) {
    $.getJSON("/server.php?cmd=texts_anl&id="+id, function (data) {
        text_list_load();
    });
}
    
function text_show(id,raw) {
    $(".main-text").hide();
    $("#main-text-texts_show").show();
    if(raw == 0) {
        $("#text-show-status").html("<h2 style=\"color:red\"><b>RAW</b></h2>");
        $.getJSON("/server.php?cmd=texts_lst&raw=on&id="+id, function (data) {
            $("#text-show-div").html(data[0]['raw']);
        });
    } else {
        $("#text-show-div").html("Loading...");
        $("#text-show-status").html("<h2 style=\"color:lightblue\"><b>PROCESSED</b></h2>");
        $.getJSON("/server.php?cmd=sentences_lst&raw=on&text="+id, function (data) {
            $("#text-show-div").html("");
            $.each( data , function (key, val) {
                var s = "<a name=\"text-show-jmp-"+val["id"]+"\">";
                s += "<div align=left id=\"text-show-menu-"+val["id"]+"\">";
                s += "<a href=\"javascript:text_show_menu("+val["id"]+")\">";
                s += "<span class=\"glyphicon glyphicon-option-vertical\" ";
                s += " aria-hidden=\"true\"></span></a><b id=\"text-show-seq-"+val["id"]+"\">";
                s += val["sequence"]+"</b> "+val['raw']+"</div></a>";
                $(s).appendTo("#text-show-div");
            } );
        });
    }
}
    
function text_clear() {
    $("#text-name").val("");
    $("#text-author").val("");
    $("#text-input").val("");
    $("#text-status").addClass("hidden");
}
    
function text_upload() {
    var text = $("#text-input").val();
    text = text.replace(/\r?\n/g, '<br />');
    $.ajax({
        url: '/server.php',
        type: 'POST',
        data: { 
            raw: text , 
            name: $("#text-name").val(),
            author: $("#text-author").val(),
            lang: 1,
            cmd: 'texts_new'},
        success: function(result) {
            $("#text-status").removeClass("hidden");
            if(result['id'] > 0) {
                $("#text-status").removeClass("alert-warning").addClass("alert-success").text('Text was successfully uploaded to the server');
            } else {
                $("#text-status").removeClass("alert-success").addClass("alert-warning").text('Some error!');
            }
        },
        error: function( jqXHR, textStatus, errorThrown ) {
            $("#text-status").removeClass("alert-success").addClass("alert-warning").text('Error!'+textStatus);
        }
    });
}
  
//
// Dictionary
//
    
function dics_click(firstrun) {
    if(firstrun) {
        $('#dic-file').change( function() {
            files = this.files;
        });
        dic_list_load();
    }
}
    
function dic_click( item ) {
    $(".dic-page").hide();
    $(".dic-pill").removeClass("active");
    $("#dic-page-"+item).show();
    $("#dic-pill-"+item).addClass("active").show();
    if(item == "dict") {
        dic_list_load();
    }
    if(item == "dicadd") {
        $("#dic-status").hide();
    }
}
    
function dic_list_load() {
    $("#dic-dict-tbl").html("");
    $.getJSON("/server.php?cmd=dic_lst", function (data) {
        $.each( data , function (key, val) {
            var id = val['id'];
            var s = "<tr>";
            s += "<td><a href=\"javascript:dic_view("+id+")\"><b>"+val["name"]+"</b></a></td>";
            s += "<td>"+val["ws_status"]+"</td>";
            s += "<td>"+val["lang"]+"</td>";
            s += "<td>"+val["url"]+"</td>";
            s += "<td>"+val["ts"]+"</td>";
            s += "<td>"+val["user"]+" </td>";
            s += "</tr>";
            s += "<tr><td colspan=6>";
            s += val["comment"]+"</td></tr>";
            $(s).appendTo("#dic-dict-tbl");
        });
    }); 
}
 
function dic_clear() {
    $("#dic-name").val("");  
    $("#dic-url").val("");  
    $("#dic-comment").val("");  
}
    
var files;
    
function dic_upload(id) {
    var data = new FormData();
    $.each( files, function( key, value ){
        data.append( key, value );
    });
    data.append("cmd","dic_upl");
    data.append("id",id);
    $.ajax({
        url: '/server.php',
        type: 'POST',
        cache: false,
        dataType: 'json',
        processData: false, // Не обрабатываем файлы (Don't process the files)
        contentType: false, // Так jQuery скажет серверу что это строковой запрос
        data: data,
        success: function (result) {},
        error: function( jqXHR, textStatus, errorThrown ) {}
    });
}
    
function dic_process( action, id ) {
    if(action == "del") {
        $.getJSON("/server.php?cmd=dic_del&id="+id, function(data) {});
        $("#dic-pill-dicadd").hide();
        dic_clear();
        dic_click( "dict" );
    }
    if(action == "upd") {
        var text = $("#dic-comment").val();
        text = text.replace(/\r?\n/g, '<br />');
        $.ajax({
            url: '/server.php',
            type: 'GET',
            data: { 
                id:     id,
                name:   $("#dic-name").val(), 
                url:    $("#dic-url").val(),
                comment: text,  
                cmd :   'dic_upd' },
            success: function(result) {
                $("#dic-status").removeClass("hidden");
                if(result['id'] > 0) {
                    $("#dic-status").removeClass("alert-warning").addClass("alert-success").text('Record was successfully updated');
                    $("#dic-pill-dicadd").hide();
                    dic_clear();
                    dic_click( "dict" );
                } else {
                    $("#dic-status").removeClass("alert-success").addClass("alert-warning").text('Some error!');
                }
            },
            error: function( jqXHR, textStatus, errorThrown ) {
                $("#dic-status").removeClass("alert-success").addClass("alert-warning").text('Error! '+textStatus);
            }
        });
    }
}    
    
function dic_add_dic() {
    dic_clear();
    $("#dic-page-dicadd-del").hide();
    $("#dic-page-dicadd-sub").attr("href","javascript:dic_process('upd',-1)").text("Add new");
    $("#dic-file-btn").attr("href","javascript:dic_upload(-1)");
    dic_click( "dicadd" );
}
    
function dic_view(id) {
    dic_clear();
    $.getJSON("/server.php?cmd=dic_lst&id="+id, function (data) {
        $("#dic-name").val(data[0]["name"]);  
        $("#dic-url").val(data[0]["url"]); 
        var text = data[0]["comment"];
        text = text.replace(/<br \/>/g, "\n");
        $("#dic-comment").val(text);  
        $("#dic-file-btn").attr("href","javascript:dic_upload("+data[0]["id"]+")");
        $("#dic-page-dicadd-sub").attr("href","javascript:dic_process('upd',"+data[0]["id"]+")").text("Update");
        $("#dic-page-dicadd-del").attr("href","javascript:dic_process('del',"+data[0]["id"]+")").show();
    });
    dic_click( "dicadd" );
}
    
//
// Auth
//
    
function connectionTest() {
    $("#main-text-").show();
    $("#test").html("<p class='label label-info'>Testing connеction to server ... </p>");
    $.getJSON("/server.php?cmd=hello") 
        .done( function( data ) {
            auth = false;
            if(data['auth']==true||data['auth']=="true") {
                if(!auth) {
                    auth = true;
                    show_all();
                }
            }
            if(data["hello"]!="ok") {
                $("#test").html("<div class=\"label label-danger\">No connection to server!</div>");
            }
            if(data["hello"]=="ok"&&!auth) {
                $("#test").html("<div class=\"label label-warning\">You need to enter login and password!</div>");
            }
            if(auth) {
                $("#test").html("")
                $("#login_form").hide();
                $("#main-text-hello").html("<h2>Hello "+data['session_user_name']+" !</h2>");
            }
        })
        .fail( function( jqxhr, textStatus, error ) {
            $("#test").html("<div class='label label-danger'> Status - "+textStatus + ", error - " + error + "</div>"+
                "<br/><br/><div class='btn btn-primary' onClick=connectionTest()>Test again</div>");
        });
}

function submit_auth() {
    $.getJSON("/server.php?cmd=auth&auth_name="+$("#exampleInputEmail1").val()+"&auth_pass="+$("#exampleInputPassword1").val(), 
        function( data ) {
            connectionTest();
    });
}    
    
function logout() {
    $.getJSON("/server.php?cmd=logout", 
        function( data ) {
            //$("#main-text-user").append("<div>"+data["auth"]+"</div>");
            auth = false;
            location.replace(location.origin+location.pathname);
        });
}  
  
//
// Menu
//
    
// Menu data    
var menu = {
    analytic : "Analytic",
    texts    : {
        texts  : "Texts",
        texts_upload : "Upload"
    }, 
    dics     : "Dictionary",
    user     : "User",
    test     : { 
        test : "test",
        tst1 : "test1",
        tst2 : "test2"
    }
};
  
function menuClick(item) {
    if(item!="") { 
        $("#menu-item-").css("color","darkgray"); //#101010
    } else { 
        $("#menu-item-").css("color","white"); 
    }
    $(".menu-item").removeClass("active");
    $(".menu-item-" + item).addClass("active");
    $(".main-text").hide();
    $("#main-text-" + item ).show();
    if(isFunc(item+"_click")) 
        eval(item+"_click("+$("#menu-item-"+item).hasClass('first-run')+")");
    $("#menu-item-"+item).removeClass('first-run');
}
    
function show_menu() {
    $.each( menu , function (key, val) {
        var activeClass = "";
        var s = "";
        if( typeof(val) == "object" ) {
            s = "<li id=\"menu-item-"+key+"\" class=\"menu-item first-run dropdown";
            $.each(val, function (akey, aval) {
                s += " menu-item-"+akey+" ";
            });
            s += "\">";
            s += "<a href=\"#\" onclick='menuClick(\""+key+"\")' class=\"dropdown-toggle\" data-toggle=\"dropdown\" role=\"button\" ";
            s += " aria-haspopup=\"true\" aria-expanded=\"false\">"+val[key]+"<span class=\"caret\"></span></a>";
            s += "<ul class=\"dropdown-menu\">";
            $.each(val, function (akey, aval) {
                if( key != akey )
                    s += "<li class=\"first-run menu-item\"><a href=\"#"+akey+"\" onclick='menuClick(\""+akey+"\")'>"+aval+"</a></li>"; 
            });
            s += "</ul></li>";
        }else {
            s = "<li onClick='menuClick(\""+key+"\")' class=\"first-run menu-item menu-item-"+key+"\"";
            s += "id='menu-item-"+key+"'><a href='#"+key+"'>"+val+"</a></li>";
        }
        $(s).appendTo("#menu");
    });
    if( location.hash != "" ) menuClick(location.hash.slice(1)); 
}

function show_all() {
    $("#login_form").hide();
    show_menu();
}
    
//
// User
//    

function user_click() {
    $("#user-tbl").html("");
    $.getJSON("/server.php?cmd=hello&debug=on", 
        function( data ) {
            $.each( data , function (key, val) {
                $("<tr><td>"+key+"</td><td>"+val+"</td></tr>").appendTo("#user-tbl");
            });
        });
} 
   
// Init function
$( document ).ready( function() {
    // Loading ...
    $(".main-text").hide();
    
    // Testing connection to server
    connectionTest();

});
</script>
</body>
</html>

